<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Implementation</title>
    <style>
        body { font-family: sans-serif; padding: 40px; max-width: 600px; margin: auto; }
        .section { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        h2 { margin-top: 0; }
        input { padding: 8px; margin-right: 10px; }
        button { padding: 8px 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        img { max-width: 100%; margin-top: 15px; border: 1px solid #ddd; }
        #uploadStatus { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="section">
        <h2>1. Smart Upload (Check & POST)</h2>
        <input type="file" id="fileInput">
        <button onclick="checkAndUpload()">Upload to Server</button>
        <p id="uploadStatus"></p>
    </div>

    <div class="section">
        <h2>2. Get Image (GET)</h2>
        <input type="text" id="fileNameInput" placeholder="Enter filename (e.g. cat.png)">
        <button onclick="getImage()">Fetch Image</button>
        <div id="imageContainer"></div>
    </div>

    <script>
     
        async function checkAndUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const status = document.getElementById('uploadStatus');

            if (!file) {
                alert("Please select a file first.");
                return;
            }

            
            try {
                const checkResponse = await fetch(`http://localhost:3000/api/check/${file.name}`);
                const data = await checkResponse.json();

                if (data.exists) {
                    
                    const userChoice = confirm(`The file "${file.name}" already exists on the server.\n\nPress OK to OVERWRITE it.\nPress CANCEL to VIEW the existing one.`);
                    
                    if (userChoice === true) {
                   
                        status.innerText = "Overwriting file...";
                        performUpload(file);
                    } else {
                        
                        status.innerText = "Upload cancelled. Fetching existing image...";
                        fetchAndShowImage(file.name);
                    }
                } else {
                   
                    status.innerText = "Uploading new file...";
                    performUpload(file);
                }
            } catch (error) {
                console.error("Check failed:", error);
                status.innerText = "Error connecting to server.";
                status.style.color = "red";
            }
        }

      
        async function performUpload(file) {
            const status = document.getElementById('uploadStatus');
            const formData = new FormData();
            formData.append('imageFile', file);

            try {
                const response = await fetch('http://localhost:3000/api/upload', {
                    method: 'POST',
                    body: formData
                });
                const text = await response.text();
                status.innerText = text;
                status.style.color = "green";
                
               
                fetchAndShowImage(file.name);
            } catch (error) {
                console.error(error);
                status.innerText = "Upload failed.";
                status.style.color = "red";
            }
        }

       
        async function fetchAndShowImage(filename) {
            const container = document.getElementById('imageContainer');
       
            const timestamp = new Date().getTime();
            const imageUrl = `http://localhost:3000/api/image/${filename}?t=${timestamp}`;

            container.innerHTML = `
                <p><strong>Showing: ${filename}</strong></p>
                <img src="${imageUrl}" onerror="this.style.display='none'; alert('Error loading image')">
            `;
            
            
            document.getElementById('fileNameInput').value = filename;
        }

      
        function getImage() {
            const filename = document.getElementById('fileNameInput').value;
            if (!filename) {
                alert("Please enter a filename.");
                return;
            }
            fetchAndShowImage(filename);
        }
    </script>
</body>
</html>
